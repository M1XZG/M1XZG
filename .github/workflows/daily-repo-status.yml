name: Daily Repo Status Report

on:
  schedule:
    - cron: '0 7 * * *' # Runs daily at 07:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  daily-status:
    runs-on: self-hosted
    env:
      GH_TOKEN: ${{ secrets.MY_GH_PAT }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate daily repo status report
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          DATE=$(date -u +"%Y-%m-%d")
          DAY_OF_WEEK=$(date -u +"%A")
          SINCE=$(date -u -d "1 day ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-1d +"%Y-%m-%dT%H:%M:%SZ")
          CLOSED_SINCE=$(date -u -d "7 days ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-7d +"%Y-%m-%dT%H:%M:%SZ")

          # â”€â”€ Gather counts upfront for the dashboard â”€â”€
          OPEN_ISSUE_COUNT=$(gh issue list --repo "$REPO" --state open --json number --jq 'length' 2>/dev/null || echo "0")
          OPEN_PR_COUNT=$(gh pr list --repo "$REPO" --state open --json number --jq 'length' 2>/dev/null || echo "0")
          COMMIT_COUNT=$(gh api "repos/${REPO}/commits?since=${SINCE}&per_page=100" --jq 'length' 2>/dev/null || echo "0")
          CLOSED_ISSUE_COUNT=$(gh api "repos/${REPO}/issues?state=closed&since=${CLOSED_SINCE}&per_page=100" \
            --jq '[.[] | select(.pull_request == null)] | length' 2>/dev/null || echo "0")
          MERGED_PR_COUNT=$(gh pr list --repo "$REPO" --state merged --limit 100 \
            --json mergedAt \
            --jq '[.[] | select(.mergedAt >= "'"${CLOSED_SINCE}"'")] | length' 2>/dev/null || echo "0")

          # â”€â”€ Health indicator â”€â”€
          if [ "$OPEN_ISSUE_COUNT" -eq 0 ] 2>/dev/null && [ "$OPEN_PR_COUNT" -eq 0 ] 2>/dev/null; then
            HEALTH="ğŸŸ¢ All Clear"
          elif [ "$OPEN_PR_COUNT" -gt 5 ] 2>/dev/null || [ "$OPEN_ISSUE_COUNT" -gt 20 ] 2>/dev/null; then
            HEALTH="ğŸŸ¡ Needs Attention"
          else
            HEALTH="ğŸ”µ Normal"
          fi

          REPORT=""

          # â”€â”€ Header â”€â”€
          REPORT+="# ğŸ“Š Daily Repo Status â€” ${DAY_OF_WEEK}, ${DATE}\n\n"
          REPORT+="> Repository: **${REPO}** Â· Status: **${HEALTH}**\n\n"

          # â”€â”€ Dashboard cards â”€â”€
          REPORT+="## ğŸ¯ At a Glance\n\n"
          REPORT+="| ğŸ“ Commits (24h) | ğŸ› Open Issues | ğŸ”€ Open PRs | âœ… Closed Issues (7d) | ğŸ”— Merged PRs (7d) |\n"
          REPORT+="|:---:|:---:|:---:|:---:|:---:|\n"
          REPORT+="| **${COMMIT_COUNT}** | **${OPEN_ISSUE_COUNT}** | **${OPEN_PR_COUNT}** | **${CLOSED_ISSUE_COUNT}** | **${MERGED_PR_COUNT}** |\n\n"

          # â”€â”€ Recent Commits (last 24h) â”€â”€
          REPORT+="---\n\n"
          REPORT+="<details>\n<summary><h2>ğŸ“ Recent Commits (last 24h)</h2></summary>\n\n"
          COMMITS=$(gh api "repos/${REPO}/commits?since=${SINCE}&per_page=20" \
            --jq '.[] | "| [`\(.sha[0:7])`](\(.html_url)) | \(.commit.message | split("\n")[0]) | \(.commit.author.name) |"' 2>/dev/null || true)
          if [ -n "$COMMITS" ]; then
            REPORT+="| Commit | Message | Author |\n|:---|:---|:---|\n"
            REPORT+="${COMMITS}\n\n"
          else
            REPORT+="ğŸ’¤ _No commits in the last 24 hours._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Open Issues â”€â”€
          REPORT+="<details>\n<summary><h2>ğŸ› Open Issues (${OPEN_ISSUE_COUNT})</h2></summary>\n\n"
          ISSUES=$(gh issue list --repo "$REPO" --state open --limit 15 \
            --json number,title,createdAt,labels,url \
            --jq '.[] | "| [#\(.number)](\(.url)) | \(.title) | \(if (.labels | length) > 0 then ([.labels[].name] | map("`\(.)`") | join(" ")) else "â€”" end) | \(.createdAt | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$ISSUES" ]; then
            REPORT+="| Issue | Title | Labels | Created |\n|:---|:---|:---|:---|\n"
            REPORT+="${ISSUES}\n\n"
          else
            REPORT+="ğŸ‰ _No open issues â€” nice!_\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Recently Closed Issues (last 7 days) â”€â”€
          REPORT+="<details>\n<summary><h2>âœ… Recently Closed Issues (7d)</h2></summary>\n\n"
          CLOSED_ISSUES=$(gh api "repos/${REPO}/issues?state=closed&since=${CLOSED_SINCE}&per_page=15" \
            --jq '[.[] | select(.pull_request == null)] | .[] | "| [#\(.number)](\(.html_url)) | \(.title) | \(.closed_at | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$CLOSED_ISSUES" ]; then
            REPORT+="| Issue | Title | Closed |\n|:---|:---|:---|\n"
            REPORT+="${CLOSED_ISSUES}\n\n"
          else
            REPORT+="ğŸ“­ _No issues closed in the last 7 days._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Open Pull Requests â”€â”€
          REPORT+="<details>\n<summary><h2>ğŸ”€ Open Pull Requests (${OPEN_PR_COUNT})</h2></summary>\n\n"
          PRS=$(gh pr list --repo "$REPO" --state open --limit 15 \
            --json number,title,createdAt,url,isDraft,author \
            --jq '.[] | "| [#\(.number)](\(.url)) | \(.title) | \(.author.login) | \(if .isDraft then "ğŸ“ Draft" else "ğŸŸ¢ Ready" end) | \(.createdAt | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$PRS" ]; then
            REPORT+="| PR | Title | Author | Status | Created |\n|:---|:---|:---|:---|:---|\n"
            REPORT+="${PRS}\n\n"
          else
            REPORT+="âœ¨ _No open pull requests._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Recently Merged PRs (last 7 days) â”€â”€
          REPORT+="<details>\n<summary><h2>ğŸ”— Recently Merged PRs (7d)</h2></summary>\n\n"
          MERGED_PRS=$(gh pr list --repo "$REPO" --state merged --limit 15 \
            --json number,title,mergedAt,url,author \
            --jq '.[] | select(.mergedAt >= "'"${CLOSED_SINCE}"'") | "| [#\(.number)](\(.url)) | \(.title) | \(.author.login) | \(.mergedAt | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$MERGED_PRS" ]; then
            REPORT+="| PR | Title | Author | Merged |\n|:---|:---|:---|:---|\n"
            REPORT+="${MERGED_PRS}\n\n"
          else
            REPORT+="ğŸ“­ _No PRs merged in the last 7 days._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Latest Releases â”€â”€
          REPORT+="<details>\n<summary><h2>ğŸš€ Latest Releases</h2></summary>\n\n"
          RELEASES=$(gh release list --repo "$REPO" --limit 3 \
            --json tagName,name,publishedAt,url \
            --jq '.[] | "| [\(.tagName)](\(.url)) | \(.name) | \(.publishedAt | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$RELEASES" ]; then
            REPORT+="| Tag | Name | Published |\n|:---|:---|:---|\n"
            REPORT+="${RELEASES}\n\n"
          else
            REPORT+="ğŸ“­ _No releases found._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Discussions (if enabled) â”€â”€
          REPORT+="<details>\n<summary><h2>ğŸ’¬ Recent Discussions</h2></summary>\n\n"
          DISCUSSIONS=$(gh api "repos/${REPO}/discussions?per_page=5" \
            --jq '.[] | "| [#\(.number)](\(.html_url)) | \(.title) | \(.created_at | split("T")[0]) |"' 2>/dev/null || true)
          if [ -n "$DISCUSSIONS" ]; then
            REPORT+="| # | Title | Created |\n|:---|:---|:---|\n"
            REPORT+="${DISCUSSIONS}\n\n"
          else
            REPORT+="ğŸ“­ _No recent discussions (or discussions not enabled)._\n\n"
          fi
          REPORT+="</details>\n\n"

          # â”€â”€ Actionable Next Steps â”€â”€
          REPORT+="---\n\n"
          REPORT+="## ğŸš¦ Recommended Actions\n\n"
          HAS_ACTIONS=false
          if [ "$OPEN_PR_COUNT" -gt 0 ] 2>/dev/null; then
            REPORT+="- [ ] ğŸ”€ Review and merge/close **${OPEN_PR_COUNT}** open pull request(s)\n"
            HAS_ACTIONS=true
          fi
          if [ "$OPEN_ISSUE_COUNT" -gt 0 ] 2>/dev/null; then
            REPORT+="- [ ] ğŸ› Triage and address **${OPEN_ISSUE_COUNT}** open issue(s)\n"
            HAS_ACTIONS=true
          fi
          if [ "$HAS_ACTIONS" = false ]; then
            REPORT+="ğŸ‰ **All clear!** No open issues or PRs requiring attention. Great job!\n"
          fi

          REPORT+="\n---\n\n"
          REPORT+="<sub>ğŸ¤– Auto-generated by [Daily Repo Status](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) Â· ${DAY_OF_WEEK}, ${DATE}</sub>"

          # Write report to file for the next step
          echo -e "$REPORT" > /tmp/daily-status-report.md

      - name: Create status issue
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "ğŸ“Š [repo status] ${DATE}" \
            --label "report" \
            --body-file /tmp/daily-status-report.md
