name: Daily Repo Status Report (WF)

on:
  schedule:
    - cron: 45 6 * * * # Runs daily at 06:45 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  daily-status:
    runs-on: self-hosted
    env:
      GH_TOKEN: ${{ secrets.MY_GH_PAT }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate daily repo status report
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          DATE=$(date -u +"%Y-%m-%d")
          DAY_OF_WEEK=$(date -u +"%A")
          SINCE=$(date -u -d "1 day ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-1d +"%Y-%m-%dT%H:%M:%SZ")
          CLOSED_SINCE=$(date -u -d "7 days ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-7d +"%Y-%m-%dT%H:%M:%SZ")

          # ‚îÄ‚îÄ Get all public repos owned by the user ‚îÄ‚îÄ
          REPOS=$(gh repo list "$OWNER" --source --no-archived --limit 100 --json nameWithOwner --jq '.[].nameWithOwner')

          REPORT=""
          REPORT+="# üìä Daily Status ‚Äî ${DAY_OF_WEEK}, ${DATE}\n\n"
          REPORT+="> Owner: **${OWNER}** ¬∑ Covering all public repos\n\n"

          # ‚îÄ‚îÄ Global summary table ‚îÄ‚îÄ
          REPORT+="## üéØ Cross-Repo Summary\n\n"
          REPORT+="| Repository | üìù Commits (24h) | üêõ Open Issues | üîÄ Open PRs | ‚úÖ Closed (7d) | üîó Merged (7d) | Health |\n"
          REPORT+="|:---|:---:|:---:|:---:|:---:|:---:|:---:|\n"

          TOTAL_COMMITS=0
          TOTAL_OPEN_ISSUES=0
          TOTAL_OPEN_PRS=0
          TOTAL_CLOSED_ISSUES=0
          TOTAL_MERGED_PRS=0
          ACTIVE_REPOS=""

          for REPO in $REPOS; do
            COMMIT_COUNT=$(gh api --paginate "repos/${REPO}/commits?since=${SINCE}&per_page=100" --jq 'length' 2>/dev/null | awk '{s+=$1} END {print s+0}' || echo "0")
            OPEN_ISSUE_COUNT=$(gh issue list --repo "$REPO" --state open --limit 9999 --json number --jq 'length' 2>/dev/null || echo "0")
            OPEN_PR_COUNT=$(gh pr list --repo "$REPO" --state open --limit 9999 --json number --jq 'length' 2>/dev/null || echo "0")
            CLOSED_ISSUE_COUNT=$(gh api --paginate "repos/${REPO}/issues?state=closed&since=${CLOSED_SINCE}&per_page=100" \
              --jq '[.[] | select(.pull_request == null)] | length' 2>/dev/null | awk '{s+=$1} END {print s+0}' || echo "0")
            MERGED_PR_COUNT=$(gh pr list --repo "$REPO" --state merged --limit 9999 \
              --json mergedAt \
              --jq '[.[] | select(.mergedAt >= "'"${CLOSED_SINCE}"'")] | length' 2>/dev/null || echo "0")

            TOTAL_COMMITS=$((TOTAL_COMMITS + COMMIT_COUNT))
            TOTAL_OPEN_ISSUES=$((TOTAL_OPEN_ISSUES + OPEN_ISSUE_COUNT))
            TOTAL_OPEN_PRS=$((TOTAL_OPEN_PRS + OPEN_PR_COUNT))
            TOTAL_CLOSED_ISSUES=$((TOTAL_CLOSED_ISSUES + CLOSED_ISSUE_COUNT))
            TOTAL_MERGED_PRS=$((TOTAL_MERGED_PRS + MERGED_PR_COUNT))

            # Health indicator per repo
            if [ "$OPEN_ISSUE_COUNT" -eq 0 ] 2>/dev/null && [ "$OPEN_PR_COUNT" -eq 0 ] 2>/dev/null; then
              HEALTH="üü¢"
            elif [ "$OPEN_PR_COUNT" -gt 5 ] 2>/dev/null || [ "$OPEN_ISSUE_COUNT" -gt 20 ] 2>/dev/null; then
              HEALTH="üü°"
            else
              HEALTH="üîµ"
            fi

            # Only show repos with any activity or open items
            if [ "$COMMIT_COUNT" -gt 0 ] || [ "$OPEN_ISSUE_COUNT" -gt 0 ] || [ "$OPEN_PR_COUNT" -gt 0 ] || [ "$CLOSED_ISSUE_COUNT" -gt 0 ] || [ "$MERGED_PR_COUNT" -gt 0 ]; then
              REPO_SHORT="${REPO#${OWNER}/}"
              REPORT+="| [${REPO_SHORT}](https://github.com/${REPO}) | ${COMMIT_COUNT} | ${OPEN_ISSUE_COUNT} | ${OPEN_PR_COUNT} | ${CLOSED_ISSUE_COUNT} | ${MERGED_PR_COUNT} | ${HEALTH} |\n"
              ACTIVE_REPOS="${ACTIVE_REPOS} ${REPO}"
            fi
          done

          REPORT+="| **Totals** | **${TOTAL_COMMITS}** | **${TOTAL_OPEN_ISSUES}** | **${TOTAL_OPEN_PRS}** | **${TOTAL_CLOSED_ISSUES}** | **${TOTAL_MERGED_PRS}** | |\n\n"

          # ‚îÄ‚îÄ Per-repo details for active repos ‚îÄ‚îÄ
          for REPO in $ACTIVE_REPOS; do
            REPO_SHORT="${REPO#${OWNER}/}"
            REPORT+="---\n\n"
            REPORT+="<details>\n<summary><h2>üì¶ ${REPO_SHORT}</h2></summary>\n\n"

            # Recent Commits
            COMMITS=$(gh api "repos/${REPO}/commits?since=${SINCE}&per_page=10" \
              --jq '.[] | "| [`\(.sha[0:7])`](\(.html_url)) | \(.commit.message | split("\n")[0] | if length > 80 then .[:80] + "‚Ä¶" else . end) | \(.commit.author.name) |"' 2>/dev/null || true)
            if [ -n "$COMMITS" ]; then
              REPORT+="### üìù Recent Commits\n\n"
              REPORT+="| Commit | Message | Author |\n|:---|:---|:---|\n"
              REPORT+="${COMMITS}\n\n"
            fi

            # Open Issues
            ISSUES=$(gh issue list --repo "$REPO" --state open --limit 10 \
              --json number,title,createdAt,labels,url \
              --jq '.[] | "| [#\(.number)](\(.url)) | \(.title) | \(if (.labels | length) > 0 then ([.labels[].name] | map("`\(.)`") | join(" ")) else "‚Äî" end) | \(.createdAt | split("T")[0]) |"' 2>/dev/null || true)
            if [ -n "$ISSUES" ]; then
              REPORT+="### üêõ Open Issues\n\n"
              REPORT+="| Issue | Title | Labels | Created |\n|:---|:---|:---|:---|\n"
              REPORT+="${ISSUES}\n\n"
            fi

            # Recently Closed Issues
            CLOSED_ISSUES=$(gh api "repos/${REPO}/issues?state=closed&since=${CLOSED_SINCE}&per_page=10" \
              --jq '[.[] | select(.pull_request == null)] | .[] | "| [#\(.number)](\(.html_url)) | \(.title) | \(.closed_at | split("T")[0]) |"' 2>/dev/null || true)
            if [ -n "$CLOSED_ISSUES" ]; then
              REPORT+="### ‚úÖ Recently Closed Issues\n\n"
              REPORT+="| Issue | Title | Closed |\n|:---|:---|:---|\n"
              REPORT+="${CLOSED_ISSUES}\n\n"
            fi

            # Open PRs
            PRS=$(gh pr list --repo "$REPO" --state open --limit 10 \
              --json number,title,createdAt,url,isDraft,author \
              --jq '.[] | "| [#\(.number)](\(.url)) | \(.title) | \(.author.login) | \(if .isDraft then "üìù Draft" else "üü¢ Ready" end) | \(.createdAt | split("T")[0]) |"' 2>/dev/null || true)
            if [ -n "$PRS" ]; then
              REPORT+="### üîÄ Open Pull Requests\n\n"
              REPORT+="| PR | Title | Author | Status | Created |\n|:---|:---|:---|:---|:---|\n"
              REPORT+="${PRS}\n\n"
            fi

            # Merged PRs
            MERGED_PRS=$(gh pr list --repo "$REPO" --state merged --limit 10 \
              --json number,title,mergedAt,url,author \
              --jq '.[] | select(.mergedAt >= "'"${CLOSED_SINCE}"'") | "| [#\(.number)](\(.url)) | \(.title) | \(.author.login) | \(.mergedAt | split("T")[0]) |"' 2>/dev/null || true)
            if [ -n "$MERGED_PRS" ]; then
              REPORT+="### üîó Recently Merged PRs\n\n"
              REPORT+="| PR | Title | Author | Merged |\n|:---|:---|:---|:---|\n"
              REPORT+="${MERGED_PRS}\n\n"
            fi

            REPORT+="</details>\n\n"
          done

          # ‚îÄ‚îÄ Actionable Next Steps ‚îÄ‚îÄ
          REPORT+="---\n\n"
          REPORT+="## üö¶ Recommended Actions\n\n"
          HAS_ACTIONS=false
          if [ "$TOTAL_OPEN_PRS" -gt 0 ] 2>/dev/null; then
            REPORT+="- [ ] üîÄ Review and merge/close **${TOTAL_OPEN_PRS}** open pull request(s) across all repos\n"
            HAS_ACTIONS=true
          fi
          if [ "$TOTAL_OPEN_ISSUES" -gt 0 ] 2>/dev/null; then
            REPORT+="- [ ] üêõ Triage and address **${TOTAL_OPEN_ISSUES}** open issue(s) across all repos\n"
            HAS_ACTIONS=true
          fi
          if [ "$HAS_ACTIONS" = false ]; then
            REPORT+="üéâ **All clear!** No open issues or PRs requiring attention across any repos. Great job!\n"
          fi

          REPORT+="\n---\n\n"
          REPORT+="<sub>ü§ñ Auto-generated by [Daily Repo Status](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ¬∑ ${DAY_OF_WEEK}, ${DATE}</sub>"

          # Write report to file for the next step
          echo -e "$REPORT" > /tmp/daily-status-report.md

      - name: Create status issue
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "üìä [repo status] ${DATE}" \
            --label "report" \
            --body-file /tmp/daily-status-report.md

